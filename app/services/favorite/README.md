# 关于点赞模块的说明

1. 本分支目前「2023年08月14日 15:31:53」是基于etcd_demo模块开发，合并了lxxx分支
2. 点赞、取消点赞、获取点赞列表本地测试没有问题
3. 相较于etcd_demo模块的变化
    1. 服务注册发现模块部分改动，增加了discovery/initDiscovery.go `func LoadClient`的错误处理
    2. 对initRegister监听与初始化错误处理做了Fatal
    3. 添加了favorite模块，数据库models，相关的protos，增加了部分配置信息
    4. 使用了mysql、redis、kafka
4. 对于lxxx分支
    1. 使用了jwt验证模块进行token鉴权和userid提取
    2. repo.Init错误暂时没有返回，我的处理思路为，数据库如果启动失败，直接结束程序，因此没有返回错误



点赞模块的流程说明

因为点赞是高频操作所以我也参考了别人的用了redis缓存，使用kafka作为消息队列

点赞流程如下：（取消点赞流程类似）

1. 用户(userid=10086)点赞某个视频（视频id=10010）
2. 在redis中查找是否存在key为（favor:10086）的集合，不存在就从mysql中读取出10086用户的所有点赞视频数据，然后写入redis
3. 查找出该key（favor:10086）后，把value（10010）写入set中，如果影响的行数为0，说明该视频已经点赞过，直接返回，如果影响的行数为1，说明redis点赞成功
4. redis点赞成功后，将点赞消息放入消息队列kafka，放入成功，则返回点赞成功的消息，放入失败，则不算点赞成功



1. 消息队列消费者，会持续消费，收到消息，即会进行解析，写入数据库，保证和redis的同步
2. 因为我对kafka也不太熟悉，使用的消息队列的另一个用处，流量削峰，避免对数据库造成太大压力这点我也不确定我写的能否很好完成



查询点赞视频列表

1. 会先在redis中拉取用户的所有点赞视频id，拉取失败则从mysql中拉取
2. 再根据视频id从数据库读取详细视频数据，和作者信息，和是否点赞进行拼接



点赞模块我已经尽量添加了错误处理，增强健壮性了，如果有问题再稍稍更改